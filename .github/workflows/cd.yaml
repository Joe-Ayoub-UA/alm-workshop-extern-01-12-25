name: Release Application

on:
  # LET THE PIPELINE TRIGGER ON A PUSH TO ALL BRANCHES
  push:
    branches:
      - "*"
  release:
    types: [published]
env:
  CONTAINER_REPOSITORY: quay.io/${{secrets.JOE_USERNAME_SECRET}} # PUT YOUR OWN USERNAME HERE
  CONTAINER_IMAGE: alm-workshop-extern-01-12-25 # fixed this to the repo name
  GOLANG_VERSION: 1.23
  OCP_SERVER_URL: https://api.rm1.0a51.p1.openshiftapps.com:6443
  OCP_TOKEN: ${{secrets.OCP_TOKEN}}
  OCP_NAMESPACE: joe-ayoub-dev

jobs:
  deploy:
    if: github.ref == 'refs/heads/main' || github.event_name == 'release'
    environment: development
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Extract Tag for Deployment
        id: meta
        run: |
          # If triggered by a Release, use the release tag (e.g., v1.1.0)
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "TAG=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          # Otherwise, use the short commit SHA for tracking
          else
            echo "TAG=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Login OpenShift
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: ${{ env.OCP_SERVER_URL }}
          openshift_token: ${{ env.OCP_TOKEN }}
          namespace: ${{ env.OCP_NAMESPACE }}

      - name: Apply Openshift YAML
        run: |
          FULL_IMAGE_NAME="${{ env.CONTAINER_REPOSITORY }}/${{ env.CONTAINER_IMAGE }}:${{ steps.meta.outputs.TAG }}"

          echo "Deploying image: $FULL_IMAGE_NAME"

          # 1. Option A: Update an existing OpenShift DeploymentConfig (DC)
          # Assuming your DC is named 'my-golang-app' and the container name is 'app'
          oc set image dc/my-golang-app app=$FULL_IMAGE_NAME -n ${{ env.OCP_NAMESPACE }}

          # 2. Option B: Update an existing Kubernetes Deployment (K8s standard)
          # oc set image deployment/my-golang-app app=$FULL_IMAGE_NAME -n ${{ env.OCP_NAMESPACE }}

          # 3. Wait for the rollout to complete (highly recommended)
          echo "Waiting for rollout to finish..."
          oc rollout status dc/my-golang-app --timeout=5m -n ${{ env.OCP_NAMESPACE }}
